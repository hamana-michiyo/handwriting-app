# 手書き文字評価システム 仕様まとめ

## プロジェクト概要

お手本画像とユーザーの手書き画像を比較し、4つの軸（形・黒・白・場）で定量的に評価するシステム。

## 評価軸の詳細

### 1. 形（Shape Score）
- **定義**: スケール対応ハイブリッド形状評価による類似度
- **計算方法**: 
  - マルチスケール位置補正IoU (70%): 複数のスケールファクターで最適IoUを探索
  - 改良Huモーメント形状記述子 (30%): matchShapes + 基本形状記述子の組み合わせ
  - 重み付き統合による総合評価
- **特徴**: 
  - 位置ずれに対して完全ロバスト（同形状なら位置関係なく高スコア）
  - サイズ違いの相似形を適切に評価（0.89+の高精度）
  - 異なる形状は適切に区別
- **スコア範囲**: 0-100点
- **重み**: 30%

### 2. 黒（Black Score）
- **定義**: 線質の包括的評価（線幅安定性 + 濃淡均一性）
- **計算方法**: 
  - **線幅安定性 (60%)**：距離変換による線幅推定 + 変動係数比較
  - **濃淡均一性 (40%)**：グレースケール濃度分析 + 均一性評価
  - 重み付き統合による総合評価
- **Phase 1.5 精密化機能**（オプション）:
  - **濃淡解析の精密化**: 局所ムラ検出・エッジ強度評価・筆圧分析
  - **線幅評価の改良**: 方向性考慮・サンプリング最適化・ノイズ除去
  - **選択的統合**: 基本85% + 精密濃淡15% + 改良線幅10%
- **特徴**:
  - 線幅のブレを定量評価（既存機能強化）
  - 濃淡のムラ・薄すぎを検出（新機能）
  - 筆圧の安定性を間接的に評価
  - 精密化により局所的問題点の詳細検出（Phase 1.5）
- **スコア範囲**: 0-100点
- **重み**: 20%

### 3. 白（White Score）
- **定義**: 黒画素密度の類似度
- **計算方法**: 黒画素割合の差をガウシアン関数で評価
- **スコア範囲**: 0-100点
- **重み**: 30%

### 4. 場（Center Score）
- **定義**: 文字の配置位置の適切さ
- **計算方法**: 重心の中央からの距離
- **スコア範囲**: 0-100点
- **重み**: 20%

## 技術仕様

### 画像前処理
1. **グレースケール変換**
2. **台形補正**
   - Hough変換による直線検出
   - 四角形枠の自動認識
   - 透視変換による正規化
3. **二値化**
   - 大津の手法による自動閾値設定
   - 白背景・黒文字前提

### 形状評価アルゴリズム
1. **スケール正規化位置補正IoU**
   - 複数スケールファクター [0.5, 0.7, 0.8, 1.0, 1.2, 1.4, 2.0] で探索
   - cv2.matchTemplate()による最適位置探索
   - パディング・クリッピングによる堅牢な位置補正
   - 位置・スケール不変な重複度計算
2. **改良Huモーメント形状記述子**
   - cv2.matchShapes()による安定した形状マッチング
   - 基本形状記述子（円形度、凸性、アスペクト比）との組み合わせ
   - 位置・スケール・回転不変な形状特徴
3. **ハイブリッド統合**
   - スケール補正IoU (70%) + 改良Hu類似度 (30%)
   - 重み調整によるカスタマイズ可能

### 線質評価アルゴリズム
1. **線幅安定性評価**
   - cv2.distanceTransform()による線幅推定
   - 変動係数（CV）計算による安定性定量化
   - ガウシアン類似度による比較評価
2. **濃淡均一性評価**
   - グレースケール画像での濃度分析
   - 濃度変動係数による均一性評価
   - 薄すぎ補正 + CVペナルティ
3. **包括的統合**
   - 線幅安定性 (60%) + 濃淡均一性 (40%)
   - 筆圧・線質の多面的評価
4. **Phase 1.5 精密化機能**（enhanced_analysis=Trueで有効）
   - **濃淡解析の精密化**:
     - 局所的濃度分析：15x15スライディングウィンドウによる局所ムラ検出
     - 濃度勾配解析：Sobelフィルタによるエッジ強度・境界明瞭度評価
     - 筆圧推定精度向上：複数閾値・ヒストグラム分布形状解析
   - **線幅評価の改良**:
     - 方向性を考慮した線幅測定：縦画・横画・斜線の方向別解析
     - サンプリング密度の最適化：等間隔・適応的サンプリング
     - ノイズ除去の強化：端点効果・統計的外れ値・小連結成分除去
   - **統合重み配分**: 基本85% + 精密濃淡15% + 改良線幅10%

### パラメータ設定
```python
# 重みパラメータ
SHAPE_W  = 0.30  # 形の重み
BLACK_W  = 0.20  # 黒の重み  
WHITE_W  = 0.30  # 白の重み
CENTER_W = 0.20  # 場の重み

# Hough変換パラメータ
HOUGH_MINLEN = 70   # 最小線長
HOUGH_THRESH = 50   # 閾値

# 形状評価パラメータ
SHAPE_IOU_WEIGHT = 0.7   # スケール補正IoUの重み
SHAPE_HU_WEIGHT = 0.3    # 改良Hu類似度の重み
SCALE_FACTORS = [0.5, 0.7, 0.8, 1.0, 1.2, 1.4, 2.0]  # マルチスケール探索
MATCHSHAPES_SCALE = 2.0  # matchShapes距離のスケーリング
BASIC_SHAPE_WEIGHT = 0.4 # 基本形状記述子の重み

# 線質評価パラメータ
BLACK_WIDTH_WEIGHT = 0.6    # 線幅安定性の重み
BLACK_INTENSITY_WEIGHT = 0.4 # 濃淡均一性の重み
INTENSITY_CV_SCALE = 3.0    # 濃度CV評価のスケーリング
INTENSITY_THIN_THRESHOLD = 128.0  # 薄すぎ判定の閾値
```

## 入出力仕様

### 入力
- お手本画像（JPEGファイル）
- ユーザー手書き画像（JPEGファイル）
- オプション：画像サイズ指定（デフォルト256x256）

### 出力
```json
{
  "形": 93.2,
  "黒": 88.4,
  "白": 82.1,
  "場": 93.0,
  "total": 89.7,
  "black_details": {
    "width_stability": 99.3,
    "intensity_similarity": 28.9,
    "ref_intensity_cv": 0.266,
    "user_intensity_cv": 0.391
  }
}
```

#### 詳細出力項目説明
- **基本スコア**: 各軸の評価スコア（0-100点）
- **black_details**: 黒スコアの詳細分析
  - `width_stability`: 線幅安定性スコア
  - `intensity_similarity`: 濃淡類似度スコア
  - `ref_intensity_cv`: お手本の濃度変動係数
  - `user_intensity_cv`: ユーザーの濃度変動係数

## 使用ライブラリ
- OpenCV: 画像処理、テンプレートマッチング、Huモーメント計算
- NumPy: 数値計算、配列操作
- argparse: コマンドライン解析

## パフォーマンス特性
- **位置ロバスト性**: 同一形状で位置ずれがある場合、従来の1%から100%に完全改善
- **スケールロバスト性**: サイズ違いの相似形評価で89%+の高精度達成
  - 小さい円(2/3サイズ): 89.6%
  - 大きい円(4/3サイズ): 91.4%  
  - 2倍円: 99.5%（ほぼ完璧）
- **形状識別性**: 異なる形状は適切に区別（円vs正方形: 86.7%）
- **線質評価精度**: 多面的な線質分析による詳細評価
  - 線幅安定性: 距離変換による高精度な線幅推定
  - 濃淡均一性: グレースケール分析による筆圧評価
  - 薄すぎ・ムラ検出: 実用的な問題点指摘
- **計算効率**: OpenCVの最適化されたアルゴリズムによる高速処理
- **安定性**: マルチスケール探索とmatchShapesによる数値安定性向上

## 制約・前提条件
- 画像は四角い枠内に書かれた単一文字
- 白背景に黒文字
- 枠線は直線で構成
- 文字は枠内に収まっている

## 今後の拡張予定

### Phase 2: 高度な線質解析（計画中）
1. **リアルタイム筆圧解析**
   - 濃淡グラデーション追跡による筆圧変化検出
   - 筆の入り・抜きの美しさ評価
   - 筆圧の連続性評価

2. **筆順推定機能**
   - 濃淡パターンからの書き順推定
   - 正しい筆順との比較評価
   - 筆順ガイダンス機能

3. **書体スタイル解析**
   - 楷書・行書・草書の判定
   - スタイル一貫性の評価
   - 美的バランス評価

### Phase 3: インテリジェント評価システム（計画中）
1. **機械学習による高度評価**
   - 書道専門家の評価データによる学習モデル
   - 個人の上達傾向追跡
   - パーソナライズされた改善提案

2. **3D筆跡解析**
   - 筆圧の3次元モデリング
   - 筆の角度・傾き推定
   - 立体的な美しさ評価

3. **文脈的評価**
   - 複数文字の調和性評価
   - 文章全体のバランス評価
   - 文字間スペーシング最適化

### 基本機能拡張
1. **複数文字対応**: 文字間の調和性評価
2. **色付き文字対応**: カラー筆記具での書字評価
3. **国際化対応**: 多言語文字（ひらがな、カタカナ、アルファベット）
3. 機械学習による特徴抽出
4. Web API化
5. リアルタイム評価機能
