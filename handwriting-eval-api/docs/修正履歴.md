# 変更履歴

## v0.3.0 (2025-06-21)

### Added
- **OCRフォーム処理システム実装**
  - トンボ検出による記入用紙の歪み補正機能
  - 手書き文字の高精度画像切り出し（清・炎・葉）
  - 記入者番号・評価数字のOCR読み取り機能
  - ハイブリッド処理（文字は高精度、数字は実用レベル）

### Technical Details
- **最終版実装**: `src/core/improved_ocr_processor.py`（中間開発ファイル18個を統合・整理）
- **機能**:
  - 4点トンボ自動検出（座標範囲指定）
  - 正確なアスペクト比での透視変換
  - 相対座標系による文字領域抽出
  - 複数前処理手法による数字OCR精度向上
- **性能**:
  - 文字画像切り出し: 100%成功（3/3文字）
  - 記入者番号OCR: 部分的成功
  - 評価数字OCR: 約50%成功（6/12個）

### Changed
- **コードベース整理**
  - 中間開発ファイル削除（18個のプロトタイプ統合）
  - デバッグ画像クリーンアップ（136個削除）
  - 最終成果物のみ保持（文字画像4個 + 処理コード1個）
- **ドキュメント更新**
  - CLAUDE.md にOCRシステム詳細仕様追加
  - 次回開発予定とトラブルシューティング情報追加

### Development Workflow
- **実行コマンド**: `docker exec bimoji-workspace-handwriting-eval-api-1 python src/core/improved_ocr_processor.py`
- **処理フロー**: トンボ検出 → 透視変換 → 領域抽出 → OCR処理
- **デバッグ**: 自動画像生成による前処理確認機能

## v0.2.4 (2025-06-15)

### Added
- **FastAPI導入完了**
  - RESTful API サーバー実装（api_server.py）
    - Base64画像評価エンドポイント（/evaluate）
    - ファイルアップロード評価エンドポイント（/evaluate/upload）
    - ヘルスチェックエンドポイント（/health）
    - API情報エンドポイント（/）
  - Swagger UI自動生成ドキュメント（/docs）
  - CORS対応（フロントエンドからのアクセス許可）
  - 画像配列前処理関数（preprocess_from_array）

### Changed
- **依存関係追加**
  - fastapi==0.104.1（RESTful APIフレームワーク）
  - uvicorn[standard]==0.24.0（ASGIサーバー）
  - python-multipart==0.0.6（ファイルアップロード対応）
  - requests==2.32.4（APIテスト用）
- **評価機能のAPI化**
  - 標準評価・精密化評価の両方に対応
  - Base64画像データとファイルアップロードの両方に対応
  - 詳細診断情報のJSON形式出力

### Technical Details
- **サーバー起動**: `python api_server.py` または `uvicorn api_server:app --reload --host 0.0.0.0 --port 8001`
- **エンドポイント**: 4つのRESTful APIエンドポイント
- **レスポンス形式**: JSON（scores, success, message）
- **エラーハンドリング**: HTTPステータスコードとエラーメッセージ

## v0.2.3 (2025-06-10)

### Added
- **Phase 1.5: 精密化機能実装完了**
  - 濃淡解析の精密化（enhanced_intensity_analysis）
    - 局所的濃度分析：スライディングウィンドウによる局所ムラ検出
    - 濃度勾配解析：Sobelフィルタによるエッジ強度評価
    - 筆圧推定精度向上：複数閾値・ヒストグラム分析
  - 線幅評価の改良（improved_width_analysis）
    - 方向性を考慮した線幅測定（縦画・横画・斜線別解析）
    - サンプリング密度の最適化（等間隔・適応的サンプリング）
    - ノイズ除去の強化（端点効果・小ノイズ・外れ値除去）
  - 包括的強化黒スコア評価（comprehensive_enhanced_black_score）
    - 基本・精密・改良機能の選択的統合
    - 後方互換性保持（use_enhanced/use_improved_widthフラグ）

### Changed
- **パイプライン統合完了**
  - evaluate_pair()にenhanced_analysisパラメータ追加
  - evaluate_all()関数の精密化対応完了
  - 詳細診断情報の大幅拡張（enhanced_details, width_details追加）
- **CLIインターフェース拡張**
  - --enhancedオプション追加（Phase 1.5精密化機能）
  - 標準・精密化モードの切り替え対応
- **依存関係追加**
  - scikit-imageインストール（skeletonize, morphology機能）
  - scipy.ndimage使用（勾配計算）

### Technical Details
- **重み配分**: 基本85% + 精密濃淡15% + 改良線幅10%
- **スライディングウィンドウ**: 15x15ピクセル局所解析
- **Sobelフィルタ**: エッジ強度・境界明瞭度評価
- **方向別解析**: 縦画・横画・斜線の方向性考慮
- **ノイズ除去**: 統計的外れ値・小連結成分除去

## v0.2.2 (2025-06-10)

### Added
- **Phase 1: パラメータ最適化完了**
  - パラメータ最適化ツール（parameter_optimizer.py）
  - 詳細診断メッセージ機能
  - 線質評価性能の検証と最適化
- **診断機能強化**
  - `generate_diagnostic_messages()`: ユーザー向け改善提案
  - 線幅安定性・濃淡均一性の個別診断
  - スコア別詳細フィードバック

### Changed
- **最適化済みパラメータ設定**
  - 線幅安定性60% + 濃淡均一性40%の重み比率確定
  - 区別性能の向上（異なる線質タイプの適切な識別）
  - CV評価スケーリング（3.0）と薄すぎ判定閾値（128.0）の最適化

### Technical Details
- **パラメータ最適化実装**
  - 重み比率テスト機能
  - 区別性能評価メトリクス
  - 診断メッセージ生成アルゴリズム
- **計算効率化提案**
  - 高速計算モードオプション
  - 距離変換結果キャッシュ機能

### Documentation
- **Phase 2-3 拡張計画追加**
  - リアルタイム筆圧解析（Phase 2）
  - 機械学習による高度評価（Phase 3）
  - 筆順推定・書体スタイル解析等の詳細仕様

## v0.2.1 (2025-06-10)

### Added
- **包括的線質評価システム（黒スコア強化）**
  - 濃淡均一性解析機能（新機能）
  - グレースケール画像による濃度分析
  - 筆圧安定性の間接的評価
- **線質評価機能**
  - `analyze_stroke_intensity()`: 濃度均一性分析
  - `comprehensive_black_score()`: 線幅 + 濃淡の統合評価
  - 薄すぎ検出とムラ検出機能
- 濃淡解析テストプログラム（validation/test_intensity_analysis.py）

### Changed
- **黒スコア評価の大幅強化**
  - 線幅安定性 (60%) + 濃淡均一性 (40%) の統合評価
  - 詳細な分析結果出力（black_details）
  - 実際のサンプルでの線質問題検出向上
- パイプライン出力の詳細化（濃度変動係数など）

### Technical Details
- **濃淡均一性評価実装**
  - グレースケール領域での濃度統計解析
  - 変動係数（CV）による均一性定量化
  - 薄すぎ補正とCVペナルティの組み合わせ
- **包括的統合評価**
  - 既存線幅評価との重み付き統合
  - ガウシアン類似度による比較評価
- 前処理パイプラインでのグレースケール画像活用

### Performance
- **線質評価精度**: 多面的分析による問題点検出力向上
- **詳細診断**: 線幅・濃淡それぞれの個別評価可能
- **実用性**: 筆圧ムラや薄さの具体的検出

## v0.2.0 (2025-06-09)

### Added
- **スケール対応ハイブリッド形状評価システム**
  - マルチスケール位置補正IoU（複数スケールファクターで最適IoU探索）
  - 改良Huモーメント形状記述子（matchShapes + 基本形状記述子）
  - 重み付き統合によるハイブリッド評価
- **スケールロバスト性機能**
  - サイズ違いの相似形を適切に評価
  - スケールファクター [0.5, 0.7, 0.8, 1.0, 1.2, 1.4, 2.0] での探索
- 形状評価比較テストツール
- 位置ロバスト性テストスイート
- スケールロバスト性テストスイート

### Changed
- **形状評価アルゴリズムの大幅改善**
  - 位置ずれケース: 0.011 → 1.000 (90倍改善)
  - 異形状位置ずれ: 0.015 → 0.599 (40倍改善)
  - **スケール違い相似形評価の大幅向上**:
    - 小さい円(2/3サイズ): 0.366 → 0.896 (145%改善)
    - 大きい円(4/3サイズ): 0.448 → 0.914 (104%改善)
    - 2倍円: 0.476 → 0.995 (109%改善)
  - 実サンプル評価の安定性向上

### Technical Details
- **マルチスケール位置補正IoU実装**
  - `_calculate_scale_corrected_iou()`: 複数スケールでの最適IoU探索
  - `_scale_mask()`: OpenCVによる安定したスケール変換
- **改良Huモーメント評価実装**
  - `_improved_hu_moment_similarity()`: matchShapes + 基本形状記述子
  - `_basic_shape_similarity()`: 円形度・凸性・アスペクト比による評価
- cv2.matchShapes()による数値安定性向上
- 内部関数分離による保守性向上
- エラーハンドリングの強化

### Performance
- **位置不変性**: 完全実現（同形状なら位置関係なく高スコア）
- **スケール不変性**: 89%+の高精度達成
- **形状識別精度**: 円vs正方形で86.7%の適切な区別
- OpenCV最適化による高速処理
- メモリ効率的な実装

## v0.1.0 (2025-06-08)

### Added
- プロジェクトの初期リファクタリング
- `test.py` から機能別モジュールへの分割
  - `src/eval/preprocessing.py`: 画像前処理機能
  - `src/eval/metrics.py`: 4軸評価スコア計算
  - `src/eval/pipeline.py`: 評価パイプライン
  - `src/eval/cli.py`: コマンドラインインターフェース
- テストコード追加（`tests/` ディレクトリ）
- ドキュメント整備
- Jupyter Notebook での実験環境構築

### Changed
- ディレクトリ構成を整理
- データファイルを `data/samples/` に移動
- ファイル命名規則の統一（`ref_<文字>.jpg`, `user_<文字><番号>.jpg`）

### Technical Details
- モジュール化により保守性向上
- 各機能の責務分離
- テスタビリティの向上
- ドキュメント化の充実

## 今後のバージョン予定

### v0.3.0 (予定)
- [ ] 形状評価重みの動的調整機能
- [ ] 追加形状記述子（フーリエ記述子等）
- [ ] 階層的評価システム
- [ ] パフォーマンス最適化

### v0.4.0 (予定)
- [ ] エラーハンドリングの強化
- [ ] ログ機能の追加
- [ ] 設定ファイル対応
- [ ] より多くのテストケース

### v0.5.0 (予定) 
- [ ] 複数画像の一括評価機能
- [ ] 結果の可視化機能
- [ ] レポート生成機能

### v1.0.0 (予定)
- [ ] Web API化
- [ ] 機械学習モデルの統合
- [ ] リアルタイム評価機能
